// Generated by CoffeeScript 1.6.3
var lazy, maxRequestCount, moment, s3;

moment = require('moment');

lazy = require('lazy.js');

s3 = require('./s3');

maxRequestCount = 10;

module.exports = {
  getMostRecentBackup: function(bucket, prefix, before, callback) {
    var defaults, handler, requestCount;
    defaults = function(options) {
      return lazy(options || {}).defaults({
        Bucket: bucket,
        Prefix: prefix
      }).toObject();
    };
    requestCount = 0;
    handler = function(err, objects) {
      var marker, object;
      if (err != null) {
        callback(err);
      }
      requestCount++;
      if (objects != null ? objects.IsTruncated : void 0) {
        marker = objects.NextMarker || objects.Contents[objects.Contents.length - 1].Key;
        if (requestCount > maxRequestCount) {
          callback(new Error("Made over " + maxRequestCount + " requests to S3, aborting"));
        }
        return s3.listObjects(defaults({
          Marker: marker
        }), handler);
      }
      object = lazy((objects != null ? objects.Contents : void 0) || []).filter(function(object) {
        return moment(object.LastModified).isBefore(before);
      }).max('LastModified');
      if (object == null) {
        callback(new Error("Could not find any objects in bucket " + (JSON.stringify(bucket)) + " with prefix " + (JSON.stringify(prefix)) + " modified before " + (moment(before).format('dddd, MMMM Do YYYY, h:mm:ss a ZZ'))));
      }
      return callback(null, object);
    };
    return s3.listObjects(defaults(), handler);
  }
};
